name: Release binaries

on:
  push:
    tags:
      - 'v*.*.*'

env:
  GO_VERSION: '1.24.4'
  NODE_VERSION: '18'

jobs:
  setup-deps:
    runs-on: ubuntu-latest
    outputs:
      ubuntu-amd64: ${{ steps.ubuntu-amd64.outputs.installed }}
      ubuntu-arm64: ${{ steps.ubuntu-arm64.outputs.installed }}
    steps:
      - name: Install Ubuntu AMD64 dependencies
        id: ubuntu-amd64
        run: |
          sudo apt-get update
          sudo apt-get install -y libsqlite3-dev make gcc libc6-dev
          echo "installed=true" >> $GITHUB_OUTPUT

      - name: Install Ubuntu ARM64 dependencies
        id: ubuntu-arm64
        shell: bash
        run: |
          # Ubuntu has ARM64 packages in an entirely different repo
          sudo tee /etc/apt/sources.list.d/ubuntu.sources <<EOF > /dev/null
          Types: deb
          URIs: http://azure.archive.ubuntu.com/ubuntu/
          Suites: noble noble-updates noble-backports
          Components: main universe restricted multiverse
          Signed-By: /usr/share/keyrings/ubuntu-archive-keyring.gpg
          Architectures: amd64

          Types: deb
          URIs: http://azure.ports.ubuntu.com/ubuntu-ports/
          Suites: noble noble-updates noble-backports
          Components: main universe restricted multiverse
          Signed-By: /usr/share/keyrings/ubuntu-archive-keyring.gpg
          Architectures: arm64
          EOF

          sudo dpkg --add-architecture arm64
          sudo apt-get update -y
          sudo apt-get install -y gcc-aarch64-linux-gnu \
            libc6-arm64-cross qemu-user-binfmt libc6:arm64 libsqlite3-dev make
          echo "installed=true" >> $GITHUB_OUTPUT

  build:
    runs-on: ${{ matrix.os }}
    needs: setup-deps
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            arch: amd64
            cc: gcc
          - os: ubuntu-latest
            arch: arm64
            cc: aarch64-linux-gnu-gcc
          - os: macos-latest
            arch: amd64
            cc: clang
          - os: macos-latest
            arch: arm64
            cc: clang
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: go.sum

      - name: Cache Go build cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Cache esbuild
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-esbuild-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-esbuild-

      - name: Install esbuild
        run: npm install -g esbuild

      - name: Install macOS dependencies
        if: ${{ matrix.os == 'macos-latest' }}
        run: |
          brew update
          brew install sqlite

      - name: Build assets
        run: make assets

      - name: Build binary
        run: |
          mkdir -p build
          go build \
            -ldflags="-s -w -X main.version=${{ github.ref_name }} -X main.commit=${{ github.sha }} -X main.date=$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            -o build/mango-go-${{ matrix.os }}-${{ matrix.arch }} \
            .
        env:
          GOOS: ${{ matrix.os == 'ubuntu-latest' && 'linux' || 'darwin' }}
          CGO_ENABLED: 1
          GOARCH: ${{ matrix.arch }}
          CC: ${{ matrix.cc }}

      - name: Create release archive
        run: |
          tar -czf build/mango-go-${{ matrix.os }}-${{ matrix.arch }}.tar.gz \
            build/mango-go-${{ matrix.os }}-${{ matrix.arch }} \
            README.md LICENSE

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mango-go-${{ matrix.os }}-${{ matrix.arch }}
          path: build/mango-go-${{ matrix.os }}-${{ matrix.arch }}.tar.gz
          retention-days: 7

  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Create checksums and rename files
        run: |
          mkdir -p renamed

          # Process each artifact directory
          for dir in mango-go-*; do
            if [ -d "$dir" ]; then
              # Extract OS and arch from directory name
              os_arch=$(echo "$dir" | sed 's/mango-go-//')
              os=$(echo "$os_arch" | cut -d'-' -f1-2)
              arch=$(echo "$os_arch" | cut -d'-' -f3)

              # Map to final names
              case "$os" in
                "ubuntu-latest")
                  final_name="mango-go-linux-$arch"
                  ;;
                "macos-latest")
                  if [ "$arch" = "amd64" ]; then
                    final_name="mango-go-macos-intel"
                  else
                    final_name="mango-go-macos-$arch"
                  fi
                  ;;
              esac

              # Move and create checksum
              mv "$dir"/*.tar.gz "renamed/$final_name.tar.gz"
              sha256sum "renamed/$final_name.tar.gz" >> checksums.txt
            fi
          done

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            renamed/*.tar.gz
            checksums.txt
          generate_release_notes: true
          tag_name: ${{ github.ref_name }}
          draft: false
          prerelease: false

  docker:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=semver,pattern={{version}}
            type=raw,value=latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ github.ref_name }}
            COMMIT=${{ github.sha }}
            DATE=${{ github.event.head_commit.timestamp }}
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}

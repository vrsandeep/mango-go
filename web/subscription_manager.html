<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subscription Manager - Mango</title>
    <link rel="stylesheet" href="https://unpkg.com/phosphor-icons@1.4.2/src/css/icons.css">
    <link rel="stylesheet" href="/static/css/library_grid.css">
    <style>
        .container { max-width: 1200px; }
        .manager-controls { display: flex; gap: 1rem; margin-bottom: 1.5rem;  flex-wrap: wrap; justify-content: flex-start; }
        .manager-controls select { padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 5px; background-color: var(--card-bg); color: var(--text-color); }
        .manager-controls select option { background-color: var(--card-bg); color: var(--text-color); }
        #provider-select { padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 5px; background-color: var(--bg-color); color: var(--text-color); }
        .sub-table { width: 100%; border-collapse: collapse; }
        .sub-table th, .sub-table td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--border-color); background-color: var(--card-bg); }
        .sub-table th { background-color: var(--header-bg); }
        .sub-table td { position: relative; }
        .actions-cell button { background: none; border: none; color: var(--text-color); font-size: 1.2rem; cursor: pointer; padding: 0.25rem; }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="header-left">
            <button class="menu-toggle" id="menu-toggle-btn"><i class="ph-bold ph-list"></i></button>
            <nav class="nav-links" id="nav-links">
                <div class="sidebar-logo">
                  <svg class="header-logo" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM4 4h16v11.17l-3.17-3.17-2 2-3-3-3.17 3.17L4 12.34V4z"/></svg>
                </div>
                <a href="/library">Library</a>
                <a href="/admin">Admin</a>
                <div class="header-dropdown">
                  <button class="header-dropdown-btn" tabindex="0">Download <i class="ph-bold ph-caret-down"></i></button>
                  <div class="header-dropdown-content">
                    <span style="font-weight:600; color:var(--text-color); padding:0.5em 1.2em;">SOURCE</span>
                    <a href="/downloads/plugins">Plugins</a>
                    <hr>
                    <a href="/downloads/manager">Download Manager</a>
                    <a href="/downloads/subscriptions">Subscription Manager</a>
                  </div>
                </div>
            </nav>
        </div>
        <div class="header-right">
            <button id="theme-toggle-btn">Theme</button>
            <button id="logout-btn">Logout</button>
        </div>
    </header>
    <main class="container">
        <h1>Subscription Manager</h1>
        <div class="manager-controls">
            <select id="provider-select"><option value="">All Providers</option></select>
        </div>
        <div class="table-container">
            <table class="sub-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Provider</th>
                        <th>Subscribed</th>
                        <th>Last Checked</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="sub-table-body"></tbody>
            </table>
        </div>
    </main>
    <footer class="main-footer"><span id="version-footer"></span></footer>
    <script src="/static/js/header.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const providerSelect = document.getElementById('provider-select');
            const subTableBody = document.getElementById('sub-table-body');

            const timeAgo = (date) => {
                if (!date) return 'Never';
                const seconds = Math.floor((new Date() - date) / 1000);
                let interval = seconds / 31536000;
                if (interval > 1) return Math.floor(interval) + " years ago";
                interval = seconds / 2592000;
                if (interval > 1) return Math.floor(interval) + " months ago";
                interval = seconds / 86400;
                if (interval > 1) return Math.floor(interval) + " days ago";
                interval = seconds / 3600;
                if (interval > 1) return Math.floor(interval) + " hours ago";
                interval = seconds / 60;
                if (interval > 1) return Math.floor(interval) + " minutes ago";
                return Math.floor(seconds) + " seconds ago";
            };

            const renderTable = (subs) => {
                subTableBody.innerHTML = '';
                if (!subs || subs.length === 0) {
                    subTableBody.innerHTML = '<tr><td colspan="5">No subscriptions found.</td></tr>';
                    return;
                }
                subs.forEach(sub => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td title="${sub.series_title}">${sub.series_title}</td>
                        <td>${sub.provider_id}</td>
                        <td>${timeAgo(new Date(sub.created_at))}</td>
                        <td>${timeAgo(sub.last_checked_at ? new Date(sub.last_checked_at) : null)}</td>
                        <td class="actions-cell">
                            <button data-action="recheck" data-id="${sub.id}" title="Re-check for new chapters"><i class="ph-bold ph-arrow-clockwise"></i></button>
                            <button data-action="delete" data-id="${sub.id}" title="Delete subscription"><i class="ph-bold ph-trash"></i></button>
                        </td>
                    `;
                    subTableBody.appendChild(row);
                });
            };

            const loadSubscriptions = async () => {
                const providerID = providerSelect.value;
                const url = `/api/subscriptions${providerID ? '?provider_id=' + providerID : ''}`;
                try {
                    const response = await fetch(url);
                    const subs = await response.json();
                    renderTable(subs);
                } catch(e) {
                    console.error("Failed to load subscriptions", e);
                }
            };

            const loadProviders = async () => {
                try {
                    const response = await fetch('/api/providers');
                    const providers = await response.json();
                    if(providers) {
                       providers.forEach(p => {
                           const option = document.createElement('option');
                           option.value = p.id;
                           option.textContent = p.name;
                           providerSelect.appendChild(option);
                       });
                    }
                } catch(e) { console.error("Failed to load providers", e); }
            };

            subTableBody.addEventListener('click', async (e) => {
                const button = e.target.closest('button');
                if (!button) return;

                button.disabled = true; // Prevent double-clicks
                const action = button.dataset.action;
                const id = button.dataset.id;

                try {
                    if (action === 'delete') {
                        if (confirm('Are you sure you want to delete this subscription?')) {
                            await fetch(`/api/subscriptions/${id}`, { method: 'DELETE' });
                            loadSubscriptions();
                        }
                    } else if (action === 'recheck') {
                        await fetch(`/api/subscriptions/${id}/recheck`, { method: 'POST' });
                        alert('Re-check initiated. New chapters will be added to the download queue if found.');
                    }
                } catch (e) {
                    console.error(`Action ${action} failed:`, e);
                    alert(`Action ${action} failed.`);
                } finally {
                    button.disabled = false;
                }
            });

            providerSelect.addEventListener('change', () => {
                localStorage.setItem('sub_provider_filter', providerSelect.value);
                loadSubscriptions();
            });

            const init = async () => {
                await loadProviders();
                const savedProvider = localStorage.getItem('sub_provider_filter');
                if (savedProvider) providerSelect.value = savedProvider;
                await loadSubscriptions();
            };
            init();
        });
    </script>
</body>
</html>

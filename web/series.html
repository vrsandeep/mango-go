<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manga Library</title>
    <link rel="stylesheet" href="https://unpkg.com/phosphor-icons@1.4.2/src/css/icons.css">
    <link rel="stylesheet" href="/static/css/common.css">
</head>
<body>
    <header class="main-header">
        <div class="header-left">
            <button class="menu-toggle" id="menu-toggle-btn"><i class="ph-bold ph-list"></i></button>
            <svg class="header-logo" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM4 4h16v11.17l-3.17-3.17-2 2-3-3-3.17 3.17L4 12.34V4z"/></svg>
            <nav class="nav-links" id="nav-links">
                <a href="/library">Home</a>
                <a href="/admin">Admin</a>
                <!-- More links can be added here -->
            </nav>
        </div>
        <div class="header-right">
            <button id="theme-toggle-btn">Theme</button>
            <button id="logout-btn">Logout</button>
        </div>
    </header>

    <main class="container">
        <h1>Library</h1>
        <span id="total-count" class="total-count"></span>
        <div class="library-controls">
            <div class="search-bar">
                <input type="search" id="search-input" placeholder="Search series...">
            </div>
            <div class="sort-controls">
                <span>Sort by:</span>
                <select id="sort-by">
                    <option value="title">Name</option>
                    <option value="updated_at">Date Modified</option>
                    <option value="progress">Progress</option>
                </select>
                <button id="sort-dir-btn">▲</button>
            </div>
        </div>
        <div class="grid" id="series-grid"></div>
        <div class="footer">
            <button id="load-more-btn">Load More</button>
        </div>
    </main>

    <footer class="main-footer" style="text-align:center; padding: 1rem; color: #888;">
        <span id="version-footer"></span>
    </footer>
    <script src="/static/js/common.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const seriesGrid = document.getElementById('series-grid');
            const loadMoreBtn = document.getElementById('load-more-btn');
            const themeToggleBtn = document.getElementById('theme-toggle-btn');
            const menuToggleBtn = document.getElementById('menu-toggle-btn');
            const navLinks = document.getElementById('nav-links');
            const searchInput = document.getElementById('search-input');
            const sortBySelect = document.getElementById('sort-by');
            const sortDirBtn = document.getElementById('sort-dir-btn');
            const totalCountEl = document.getElementById('total-count');

            // let currentPage = 1;
            let state = {
                currentPage: 1,
                search: '',
                sortBy: 'title',
                sortDir: 'asc',
                isLoading: false,
                hasMore: true
            };

            // --- Theme Logic ---
            const applyTheme = (theme) => {
                document.body.classList.toggle('light-theme', theme === 'light');
            };
            themeToggleBtn.addEventListener('click', () => {
                const newTheme = document.body.classList.contains('light-theme') ? 'dark' : 'light';
                localStorage.setItem('theme', newTheme);
                applyTheme(newTheme);
            });

            // --- Mobile Menu Logic ---
            menuToggleBtn.addEventListener('click', () => navLinks.classList.toggle('active'));

            // --- Data Loading ---
            const loadSeries = async (reset = false) => {
                if (state.isLoading || !state.hasMore && !reset) return;
                state.isLoading = true;
                if (reset) {
                    state.currentPage = 1;
                    state.hasMore = true;
                    seriesGrid.innerHTML = '';
                }

                const url = `/api/series?page=${state.currentPage}&per_page=100&search=${state.search}&sort_by=${state.sortBy}&sort_dir=${state.sortDir}`;
                const response = await fetch(url);
                const seriesList = await response.json();

                if (reset) {
                    const total = response.headers.get('X-Total-Count');
                    totalCountEl.textContent = `${total}`;
                }

                if (!seriesList || seriesList.length < 100) {
                    state.hasMore = false;
                    loadMoreBtn.style.display = 'none';
                } else {
                    loadMoreBtn.style.display = 'block';
                }

                if (seriesList) {
                    seriesList.forEach(series => {
                        const card = document.createElement('a');
                        card.href = `/series/${series.id}`;
                        card.className = 'item-card';
                        // Prioritize custom cover, fall back to generated thumbnail
                        const coverSrc = series.custom_cover_url || series.thumbnail || '';
                        const progressPercent = series.total_chapters > 0 ? (series.read_chapters / series.total_chapters) * 100 : 0;

                        card.innerHTML = `
                            <div class="thumbnail-container">
                                <img class="thumbnail" src="${coverSrc}" alt="Cover for ${series.title}" loading="lazy">
                            </div>
                            <div class="item-title" title="${series.title}">${series.title}</div>
                            <div class="progress-bar-container">
                                <div class="progress-bar" style="width: ${progressPercent}%;"></div>
                            </div>
                        `;
                        seriesGrid.appendChild(card);
                    });
                }
                state.isLoading = false;
            };

            // --- Event Listeners ---
            loadMoreBtn.addEventListener('click', () => {
                if (!state.isLoading) {
                    state.currentPage++;
                    loadSeries();
                }
            });

            let searchTimeout;
            searchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    state.search = searchInput.value;
                    loadSeries(true);
                }, 300); // Debounce
            });

            sortBySelect.addEventListener('change', () => {
                state.sortBy = sortBySelect.value;
                loadSeries(true);
            });

            sortDirBtn.addEventListener('click', () => {
                state.sortDir = state.sortDir === 'asc' ? 'desc' : 'asc';
                sortDirBtn.textContent = state.sortDir === 'asc' ? '▲' : '▼';
                loadSeries(true);
            });

            const loadVersion = async () => {
                const response = await fetch('/api/version');
                const data = await response.json();
                document.getElementById('version-footer').textContent = `Version: ${data.version}`;
            };

            // Initial load
            applyTheme(localStorage.getItem('theme'));
            loadSeries(true); // Initial load
            loadVersion();
        });
    </script>
</body>
</html>
